<!DOCTYPE html>
<html>
<head>
	<title>窗口</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<link rel="stylesheet" href="reset.css">
	<link rel="stylesheet" href="SimpleWindow.css">
	<style type="text/css">
		.window-wrapper{
			position: relative;
			width: 80%;
			height: 500px;
			margin: 50px auto;
			border: 2px solid #333;
		}
	</style>
</head>
<body>
	<h1>SimpleWindow</h1>
	<br>
	<div class="window-wrapper" id="windowWrapper">
		
	</div>

	<br/><br/><br/><br/><br/><br/><br/>
	<br/><br/><br/><br/><br/><br/><br/>
	<h3>SimpleWindow</h3>
	
	<script type="text/javascript" src="matrix.js"></script>
	<script src="Util.js"></script>
	<script src="SimpleWindow.js"></script>

	<script type="text/javascript">

		
		var win01 = new SimpleWindow({
			top : 180,
			left : 750,
			parent : document.getElementById('windowWrapper')
		});

		var win02 = new SimpleWindow({
			parent : document.getElementById('windowWrapper')
		});

		var win03 = new SimpleWindow();


		Util.event.on(document.body, "mousedown", function mousedown(e) {
			var targetEle = e.target;
			if([].slice.call(targetEle.classList,0).indexOf("simple-window-body") >= 0){ // Target is window body.
				var srcPoint = {x : e.clientX, y : e.clientY}; // store srcPoint

				// To save window element node rotate matrix value.
				var rotateMatrix;

				// Get window element node.
				var winEle = (function(){
					var ele = targetEle;
					while(ele){
						if(ele.className === "simple-window"){
							return ele
						}else{
							ele = ele.parentNode
						}
					}
				})();

				// Get window element node center point, The rotate origin.
				var centerPoint = (function(){
					var rect = winEle.getBoundingClientRect();
					return {
						x : (rect.right + rect.left) / 2,
						y : (rect.bottom + rect.top) / 2
					}
				})();

				// The mousedown angle
				var srcAngle = getAngle(centerPoint, srcPoint);

				console.info(srcAngle);

				// Bind mousemove event.
				Util.event.on(document.body, "mousemove", mousemoveEvent);

				function mousemoveEvent(e){
					var currentPoint = {x : e.clientX, y : e.clientY};
					var currentAngle = getAngle(centerPoint, currentPoint);
					
					var changedAngle = currentAngle - srcAngle;

					if(e.shiftKey){ // Change each 10 degree
						changedAngle = Math.round(changedAngle / 10) * 10;
					}

					rotateMatrix = mat2d.rotate(mat2d.create(), (winEle._preRotateMatrix || mat2d.create()), Math.PI / 180 * changedAngle);

					winEle.style.transform = mat2d.styleStr(rotateMatrix);
				}


				// Unbind mousemove event.
				Util.event.on(document.body, "mouseup", mouseupEvent);

				function mouseupEvent(e){
					// Save preRotateMatrix value.
					winEle._preRotateMatrix = rotateMatrix;
					Util.event.off(document.body, "mousemove", mousemoveEvent);
					Util.event.off(document.body, "mouseup", mouseupEvent);
				}

			}
		});

		// Get rotate angle.
		function getAngle(sourcePoint, currentPoint){
			var pointChange = {
				x : currentPoint.x - sourcePoint.x,
				y : sourcePoint.y - currentPoint.y
			}

			var angle = Math.atan(pointChange.x/pointChange.y)/Math.PI*180
			
			pointChange.x < 0 && pointChange.y > 0 && (angle += 360)
			pointChange.y < 0 && (angle += 180)

			return angle;
		}

	</script>
</body>
</html>